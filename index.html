<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<meta name="author" content="draho.cz">
<title>Pexeso</title>
<style>
html {
	height: 100%;
}
body {
	padding: 0;
	margin: 0;
	height: 100%;
	display: flex;
	flex-direction: column;
	justify-content: center;
	background: #a8abbb;
	background: linear-gradient(0deg, #6f6f6f, #dadada00) fixed;
	font-family: Arial;
	text-align: center;
}
canvas.wait, canvas.clickable.wait {
	cursor: wait;
}
canvas.clickable {
	cursor: pointer;
}

#storno {
	display: none;
}
#form {
	margin: 64px auto 192px;
	width: 340px;
}

footer {
	position: fixed;
	right: 10px;
	bottom: 10px;
}
a {
	color: #111;
}
button, input, select {
	padding: 0.5em 0.75em;
	cursor: pointer;
	border-radius: 6px;
	border: 1px solid;
}

</style>
<script>
function $(id){
	return document.getElementById(id);
}

var img = new Image();
img.src = {
	'#alik': 'img/alik.min.png',
	"#1": 'img/1.png',
}[window.location.hash] || 'img/0.png';

function Pexeso(id, size, mode, diff){
	var SINGLE = 0, PC = 1; // mody
	var DIFFS = [0, 16, 32, 56, 80];
	var myTurn = 1;
	var status = 0;  // počet aktuálně otočených karet
	var lastI;
	var lock = 0;
	var matches = [0,0]; // score
	var cn = document.createElement("canvas");
	var sp = 3; //spacing
	var imgHeight = 108
	var edge = imgHeight+2*sp; // hrana karty
	var top = 64; // místo nahoře
	var side = 256; // místo po stranách
	cn.width = size*edge+side*2;
	cn.height = size*edge+top*2;
	$(id).appendChild(cn);
	var ctx = cn.getContext('2d');
	ctx.imageSmoothingQuality = "high"
	ctx.translate(side,top);

	/* nadepsat jména */
	var name1 = "Ty";
	var name2 = mode==PC?["pc ⭑","pc ⭑⭑","pc ⭑⭑⭑","pc ⭑⭑⭑⭑","pc ⭑⭑⭑⭑⭑"][diff]:"";
	ctx.font = "20px Arial"
	ctx.textAlign = "left";
	ctx.fillText (name1, 15-side, 37-top);
	ctx.textAlign = "right";
	ctx.fillText (name2, size*edge+side-15, 37-top);

	/* připravit karty */
	var hat = [], cards = [], mCards = [];
	for(var i=0;i<32;i++) { // nahazet náhodně obrazky do klobouku
		do {
			var card = rand(32)
		} while(hat.includes(card))
		hat.push(card);
	}
	 //promíchá všechny
	for(var i=0;i<size*size/2;i++) {
		cards[2*i] = cards[2*i+1] = hat[i]; // vybere prvních několik do hry
	}
	cards.sort(function(){ return rand(2) - 0.5 }); //promíchá dvojce na stole
	for(var i=0;i<size*size;i++)
		mCards[i] = -2; // -2 => neotočené

	drawGrid();

	function rand(max){
		return Math.floor(Math.random()*max);
	}

	function drawGrid(){
		ctx.clearRect(0, -top, size*edge, size*edge);
		for(var i in cards){
			var xx = i%size*edge;
			var yy = (i-i%size)/size*edge;
			if(cards[i]==-1) // prázdné
				ctx.clearRect(xx,yy,edge,edge);
			else{
				drawCard(32,xx,yy) // rub
        	}
		}
		ctx.textAlign = "center";
		ctx.font = "20px Arial"
		ctx.fillText (matches[1]+" : "+matches[0], size*edge/2, 37-top); //skore
	}
	function drawCard(card, x, y){ //x,y absolutně v px
		var e = edge-2*sp // vysledna hrana obrazku
		var ee = img.height // fyzicka hrana obrazku
		ctx.drawImage(img, 33*ee, 0, ee, ee, x+sp, y+sp, e, e); // podklad
		ctx.drawImage(img, card*ee, 0, ee, ee, x+sp, y+sp, e, e);
	}

	function move(i){
		var x = i%size;
		var y = (i-i%size)/size
		status++;
		var card;
		mCards[i] = card = cards[i];
		drawCard(card, x*edge, y*edge);

		if(status==2){
			if(card == cards[lastI]){ // pááááááááááááááár!
				cards[i] = cards[lastI] = mCards[i] = mCards[lastI] = -1; // sebraná

				if(myTurn)
					var xx = 15 +5*matches[myTurn] -side-sp;
				else
					var xx = -(15 +5*matches[myTurn] -side -sp) +size*edge - edge;
				var yy = edge/4*matches[myTurn];
				setTimeout(function(){drawCard(card,xx,yy)},200);
				matches[myTurn]++  // započítat body

				if(mode==PC)
					myTurn = !myTurn*1;
			}
			if(mode==PC){
				myTurn = !myTurn*1;
				lock = 1;
				cn.classList.add('wait')
				setTimeout(fold,2000-diff*250)
			}
		}
		if(status==1)
			lastI = i;
	}

	function fold(){ // otočit z5
		status = 0;
		lock = 0;
		cn.classList.remove('wait')
		lastI = -1;
		drawGrid();
		if(isEnd()){ // konec
			var txt = "Remíza!";
			if(matches[0]>matches[1]) txt = "Prohráváš";
			if(matches[0]<matches[1]) txt = "Vyhráváš!";
			ctx.font = "40px Arial"
			ctx.textAlign = "center";
			ctx.fillText (txt, size*edge/2, size*edge/2);
			return
		}
		if(mode==PC && !myTurn)
			pc();
	}

	function isEnd(){
		for(var i in cards)
			if(cards[i]!=-1)
				return false
		return true;
	}

	/* U. I. */
	function pc(){
		var foo;
		if(rand(100) < DIFFS[diff])
			foo = smart;
		else
			foo = stupid;
		setTimeout(foo,200);
		setTimeout(foo,400);
	}
	function stupid(){
		do{
			var i = rand(size*size);
		}
		while(cards[i]==-1 || i==lastI);
		move(i);
	}
	function smart(){
		var k;
		if(status==0){
			for(var i in mCards){       // hledá shody
				for(var j in mCards){
					if(mCards[i] == mCards[j] && i!=j && mCards[i] >= 0){
						k = i;
						break
					}
				}
				if(k!=undefined)
					break;
			}
		}
		if(status==1){
			for(var i in mCards){ // shody s lastCard
				if(mCards[i] == cards[lastI] && i!=lastI && mCards[i] >= 0){
					k = i;
					break;
				}
			}
		}
		if(k==undefined){   // nenajde
			var tarr = [];    //dočasné pole indexů ještě neootočených karet
			for(var i in mCards){
				if(mCards[i]==-2)
					tarr.push(i);
			}
			k = tarr[rand(tarr.length)];
		}
		move(k);
	}

	///
	function getCursorPosition(e) {
		var x = e.pageX - e.target.offsetLeft - side;
		var y = e.pageY - e.target.offsetTop - top;
		if (x % edge < sp || y % edge < sp || x % edge >= edge - sp || y % edge >= edge - sp) { // spacing
			return { x: -1, y: -1}
		}
	 	return {
			x: Math.floor(x/edge),
			y: Math.floor(y/edge)
		}
	}
	function isClicable(x,y){
		var i = y*size+x;
		return (lock || !myTurn || x<0 || x>=size || y<0 || y>=size || i == lastI || cards[i] == -1)?0:1;
	}

	/* myška události */
	cn.onclick = function(e){
		if(mode!=PC && status==2){
			fold();
			return
		}
		var coord = getCursorPosition(e);
		var x = coord.x, y = coord.y;
		var i = y*size+x;
		if(isClicable(x,y)) // platný tah
			move(i);
	}
	cn.onmousemove = function(e){
		var coord = getCursorPosition(e);
		var x = coord.x, y = coord.y;
		if(isClicable(x,y))
			cn.classList.add('clickable');
		else
			cn.classList.remove('clickable');
	}
}

window.onload = function(){
	$('form').onsubmit = function(e){
		e.preventDefault()
		this.style.display = 'none';
		$('storno').style.display = 'inline';
		var size = this.size.value;
		var mode = this.mode.value;
		var diff = this.diff.value;
		new Pexeso('box', size, mode, diff);
		return false;
	}
	$('storno').onclick = function(){
		$('box').innerHTML = '';
		this.style.display = 'none';
		$('form').style.display = 'block';
	}
	$('mode').onchange = function(){
		$('diff').style.display = this.value == 0?'none':'inline';
	}
}

</script>
</head>
<body>
<form id=form>
	<h2>Pexeso</h2>
	<select id=size>
		<option value=4>4×4</option>
		<option value=6 selected>6×6</option>
		<option value=8>8×8</option>
	</select>
	<select id=mode>
		<option value=0>trénink</option>
		<option value=1 selected>proti PC</option>
	</select>
	<select id=diff>
		<option value=0>poklidné</option>
		<option value=1>lehké</option>
		<option value=2 selected>běžné</option>
		<option value=3>těžké</option>
		<option value=4>extrémní</option>
	</select>
	<button>Hrát!</button>
</form>
<div id=box></div>
<div>
	<button id=storno>Zrušit</button>
</div>
<footer>© <a href="http://draho.cz/" target=_blank>Draho</a></footer>
</body>
</html>
